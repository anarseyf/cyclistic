---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

packages <- c("tidyr", "knitr", "ggplot2", "ggmap", "maps", "tibble", "ggnewscale", "kableExtra", "tinytex")
install.packages(setdiff(packages, rownames(installed.packages())), repos = "http://cran.us.r-project.org")

library(ggplot2)
library(ggmap)
library(maps)
library(dplyr)
library(tidyr)
library(knitr)
library(tibble)
library(ggnewscale)
library(kableExtra)

kable_custom <- function(data, ...) {
  knitr::kable(data,
    vline = "",
    format.args = list(big.mark = ","),
    ...
  ) %>%
    kable_styling(position = "left", latex_options = c("hold_position"))
}

theme_set(theme_light())
```

```{r}
agg_daily_computed_weekdays <- read.csv("agg_daily_computed_weekdays.csv")
agg_daily <- read.csv("agg_daily_duration_count.csv")
agg_hourly <- read.csv("agg_hourly_status.csv")
agg_monthly <- read.csv("agg_monthly_status.csv")
agg_weekly_status <- read.csv("agg_weekly_status.csv")
agg_monthly_type_status <- read.csv("agg_monthly_type_status.csv")
stations_diff <- read.csv("stations_diff_8am_noon_4pm.csv")
stations_diff <- read.csv("stations_diff_8am_noon_4pm.csv")
weather_correlations <- read.csv("weather_correlations.csv")

agg_daily_trips_weather <- read.csv("agg_daily_trips_weather.csv")
agg_daily_trips_weather$day <- as.Date(agg_daily_trips_weather$day)

agg_weekly_weather <- read.csv("agg_weekly_weather.csv")
agg_weekly_weather$week_start <- as.Date(agg_weekly_weather$week_start)

weekday_names_full <- c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
weekday_names_short <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
```

# Cyclistic

- Anar Seyf (anar.seyf@gmail.com)
- October 2021
- Capstone project | Google Data Analytics course #8 | Coursera

---

## Goal

The objective of the report is to show differences between **Members** (those who purchased an annual membership) and **Casual** riders (those who pay for single rides or daily passes). Every part of the analysis shows (**TODO - synonym**) those categories side-by-side.

---

## Data

The **main data source** of the report is a 12-month window (October 2020 to September 2021, inclusive) from the dataset provided by Divvy **(link TODO)**. (See data cleaning notes in the Appendix.) The data consists of over 5 million unique ride records with these columns:

* unique ride ID;
* bicycle type (classic, docked, electric);
* ride start and end time;
* start and end docking station (ID and name);
* start and end latitude/longitude;
* status (member or casual)

The **secondary data source** is the Chicago daily weather dataset from NOAA **(link TODO)** for the same time period. This seems highly pertinent background given the nature of the main data.

The 5 million individual records are condensed into hourly, daily, weekly, and monthly **aggregates**, grouped by status (member vs casual). For example, the daily aggregates table consists of 730 entries (365 for Members and Casual users each) with columns for ride count and average duration.

Throughout the report, more emphasis is given to *ride count*, as the main indicator of activity volume, than to ride *ride duration*.

---

## Analysis


### 1. Members ride more often, casual users ride for longer.

An average ride is about **28 minutes** long for casual users, **14 minutes** long for members. Members make an average of **7,479** rides per day, casual users **6,362** rides per day. (The number of distinct riders is unavailable in the data, so we can only refer to the overall population. **TODO** — so "total volume" instead of "more often"?)

Ride volume is lowest in February and highest in July-August. Casual ride volume exceeds that of Members in the summer months only.

Ride duration is nearly flat for Members throughout the year; for Casual riders it increases by a few minutes in the summer months.

(The month of February shows an abnormal peak in ride duration. It may be partially attributable to low ride volume and thus higher variance in the data, but is otherwise not readily explained here.)

```{r}

wide <- agg_monthly %>%
  select(status, month_start, duration) %>%
  spread(month_start, duration)

month_starts <- colnames(wide)[2:13]
colnames(wide) <- c("Status", months(as.Date(month_starts), abbreviate = TRUE))

wide[, -1] <- round(wide[, -1])

wide %>%
  kable_custom(
    caption = "Average ride duration (minutes)"
  )
```

```{r}

wide <- agg_monthly %>%
  select(status, month_start, avg_count) %>%
  spread(month_start, avg_count)

month_starts <- colnames(wide)[2:13]
colnames(wide) <- c("Status", months(as.Date(month_starts), abbreviate = TRUE))

wide[, -1] <- round(wide[, -1])

wide %>%
  kable_custom(
    caption = "Average daily rides (count)"
  )
```

**TODO** — kable sparklines?


### 2. Members ride all week, casual riders prefer weekends.

Members' usage remains nearly flat, falling on Sunday. Casual users do most riding starting on Friday and through the weekend, peaking on Saturday.

#### By weekday

```{r, fig.align='left'}
wide <- agg_weekly_status %>%
  select(-avg_count) %>%
  spread(dayofweek, avg_duration)

colnames(wide) <- c("Status", weekday_names_short)

wide %>% kable_custom(caption = "Average daily duration (minutes)")
```

```{r}

wide <- agg_weekly_status %>%
  select(-avg_duration) %>%
  spread(dayofweek, avg_count)

colnames(wide) <- c("Status", weekday_names_short)

wide %>%
  kable_custom(caption = "Average daily rides (count)")
```


#### Hourly

Members: weekday pattern closely matching standard working hours (especially the peak around 4-5pm). Weekend pattern much closer between the two groups, with volume peaking on Saturday afternoon.

```{r, fig.width=8, fig.height = 3}
agg_hourly %>%
  mutate(log_count = log(COUNT)) %>%
  ggplot(aes(
    x = dayofweek,
    y = factor(hour, levels = unique(rev(hour))),
    fill = log_count
  )) +
  geom_tile(color = "grey", position = position_dodge(width = 0.1)) +
  scale_fill_viridis_c(option = "plasma") +
  #  scale_fill_steps2(low = "white", mid = "yellow", high = "red", midpoint = 3) +
  facet_wrap(~IS_MEMBER) +
  labs(caption = "Ride count heatmap (time of day on vertical axis)")
```


### 3. Seasonal and Weather

**TODO** — eliminate 0 rain/snow circles.

#### Ride counts and Weather

Average daily ride count and Chicago weather, Oct'20—Sep'21, by week. Background color is average air temperature that week.

```{r, fig.width=10, fig.height=3}
# head(agg_weekly_weather, n = 3)

# data_casual = agg_daily_trips_weather %>% filter(IS_MEMBER == "false")
# data_member = agg_daily_trips_weather %>% filter(IS_MEMBER == "true") %>%
#   mutate(COUNT = -1 * COUNT)

agg_weekly_weather %>%
  ggplot(aes(x = week_start)) +
  geom_bar(aes(y = Inf, fill = avg_temp), stat = "identity", alpha = 0.3, position = "dodge") +
  scale_fill_viridis_c() +
  new_scale_fill() +
  # geom_bar(aes(y = avg_count, fill = is_member), stat = "identity") +
  geom_step(aes(y = avg_count, group = is_member, color = is_member, size = 0.5), stat = "identity") +
  geom_point(aes(y = 0, size = total_snow / 10), color = "#e30f84", alpha = 0.7) +
  geom_point(aes(y = 0, size = total_rain), color = "#2192d3", alpha = 0.7) +
  labs(caption = "Weather Oct 2020-Sep 2021. Background = avg temp, etc.")
# facet_wrap(~is_member, ncol = 1)
```

```{r}
weather_correlations %>%
  kable_custom(caption = "Correlation (r): weather and ride count")
```

The Pearson correlation factor, or **r**, (**TODO link**) is a normalized measure of how strongly two parameters are related. It ranges from -1 (perfect negative correlation) to 1 (perfect positive correlation), with 0 indicating no correlation.

At a high level, the coefficients point in the direction we'd expect. For example, ride count is negatively correlated with snow: the more snow, the fewer rides.

Ride count is strongly correlated with **air temperature** for both groups. This is clear enough from Fig.X(TODO).

**Rain** is more ambiguous. **r** is close to 0. Does this mean bike riders in Chicago are not influenced by rain at all? It is more ambiguous than that. In the 12-month period 256 days have no recorded rain, only 16 days with 1/2 inch or more daily total, and no days with 2 inches. On days with at least 1/2 inch of rain, Members rode 4% less total time, and Casual users rode 6% more. It simply did not rain enough to make this relationship clear; we are at the limits of this data.

The relationship with **Snow** is clearer, and snow itself is obviously not independent from temperature.


#### Temperature

```{r, fig.height=3}

ggplot(data = agg_daily_trips_weather, aes(x = temp_avg, y = COUNT, color = IS_MEMBER)) +
  geom_point(alpha = 0.8) +
  geom_smooth(method = "lm") +
  facet_wrap(~IS_MEMBER) +
  labs(title = "Correlation: temp vs ride count")
```

```{r, eval=TRUE, fig.height=3}
agg_daily_trips_weather %>%
  filter(AVG_DURATION < 100) %>%
  ggplot(aes(x = temp_avg, y = AVG_DURATION, color = IS_MEMBER)) +
  geom_point(alpha = 0.8) +
  geom_smooth(method = "lm") +
  facet_wrap(~IS_MEMBER) +
  labs(title = "Correlation: temp vs ride duration", caption = "Each dot represents one day")
```

These distributions confirm the basic observation from section 1: average ride duration remains nearly the same (more so for Members), but the ride volume is highly influenced by environment.

(Note: one outlier for Casual riders, 16 Feb 2021, was removed from this plot as it had an average duration of over 100 minutes. More on this in the appendix.)

```{r}
# d <- agg_weekly_weather %>%
#   filter(is_member == "true") %>%
#   filter(weekly_rain_total > 0) %>%
#   select(-is_member)

# p <- ggplot(data = d, aes(x = year_week, y = weekly_temp_avg, group = 1))

# p +
#   geom_ribbon(aes(
#     ymin = weekly_temp_min, ymax = weekly_temp_max,
#     alpha = 0.8
#   )) +
#   geom_line() +
#   geom_point(aes(y = 0, size = weekly_rain_total, color = weekly_rain_total, alpha = 0.8))
```


### 4. Geographical

(TODO)

Stations: 1288 distinct stations (saved in table). 85% of trips (4293771 out of 5051830) have both start and end station ID — we focus on those when mapping. These are split almost evenly between M (54.7%) and C.

Stations: 4007812 trips end at a different station from start; 285959 trips start and end at the same station.

### Stations

**TODO** — # of rides with start & end station (85%).
**1288** stations. Following: **casual vs members**, **8am vs 4pm**, **Monday-Friday**.

Each dot is a bike docking station. Stations highlighed **yellow-red** have more arrivals than departures for the given hour, suggesting an influx of bike traffic at that location.


```{r, eval=FALSE}
stations_diff <- stations_diff %>% arrange(diff)

index <- stations_diff$diff > 0
stations_diff$log_diff[index] <- log10(stations_diff$diff[index])
stations_diff$log_diff[stations_diff$diff <= 0] <- NA

color_scale <- scale_color_steps(low = "#ffff17", high = "#e90505", na.value = "#072d66")

map12 <- get_map(location = "Chicago", zoom = 12, maptype = "toner")
map13 <- get_map(location = "Chicago", zoom = 13, maptype = "toner")

alpha <- 0.6
darken <- 0.4
```


#### Friday afternoon (4-5pm)

```{r, eval=FALSE, fig.width = 8, fig.height = 4}
heatmap_large <- stations_diff %>%
  filter(dayofweek == 5) %>%
  filter(hour == 16)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_large, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_wrap(~is_member)
```


Let's look at the same pattern across the entire week.


#### Morning (8-9am)

```{r, eval=FALSE}
heatmap_member <- stations_diff %>%
  filter(hour == 8)

ggmap(map13, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_member, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_grid(is_member ~ dayofweek)
```

A distinct weekday pattern. Apart from volume, the "fingerprints" look similar for the two groups. On weekends it looks different: there isn't a lot of casual riding into this area in the morning.


#### Afternoon (4-5pm)

```{r, eval=FALSE, fig.width=10, fig.height=4}
heatmap_casual <- stations_diff %>%
  filter(hour == 16)

ggmap(map13, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_casual, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_grid(is_member ~ dayofweek)
```

More dispersion away from center (TODO).

---

## Conclusions

* Commuting, daily tasks?
* Similarities M vs C? Modes (work hours vs weekend)
* Lower variance for M than C. More consistent patterns.

---

## Recommendations

How to convert casual riders into members?

Recommendations:

* Suggest bikes as a mode of work commute
* Check against areas underserved by public transport, consider expanding service in those areas
* Make riding easier in colder months?
* Weather-protected bikes?


---

## Appendix

### A. Data cleanup

February: 16-Feb-2021 had a few rides of close to 24 hours. 
Overall, most long rides (12+ hours) are attributed to Casual riders, which likely corresponds to 24-hour rentals. Not enough info to interpret this further.

Presentation: log scale.
Out of scope: 

* bike types; 
* other factors (natural disasters, sporting events, etc.); 
* pricing; 
* individual user profiles
* trends (year-over-year, electric, geography, etc.)

### B. Links

Data sources (incl. Google Maps, Stamen).

### C. Tools used (and not used)

### D. Full data (weekly?)

---

## Unused graphs

#### Monthly by weekday

```{r, eval=FALSE}
plot <- agg_daily_computed_weekdays %>%
  group_by(year_month, dayofweek, IS_MEMBER) %>%
  summarize(AVG_COUNT = mean(COUNT), AVG_DURATION = mean(AVG_DURATION))

plot %>%
  ggplot(aes(x = dayofweek, y = AVG_COUNT, color = IS_MEMBER, size = AVG_DURATION)) +
  geom_point(alpha = 0.8) +
  facet_wrap(~year_month, ncol = 3)
```


#### Monthly by bike type

```{r, eval=FALSE}

agg_monthly_type_status %>%
  ggplot(aes(x = is_member, y = total_count, fill = type)) +
  geom_col() +
  facet_wrap(~year_month, ncol = 3)
```

```{r, eval=FALSE, fig.height=3}

# TODO - remove

agg_daily_trips_weather %>%
  # filter(rain > 0) %>%
  ggplot(aes(x = rain, y = COUNT, color = IS_MEMBER)) +
  geom_point(alpha = 0.8) +
  geom_smooth(method = "lm") +
  facet_wrap(~IS_MEMBER) +
  labs(title = "Correlation: rain vs ride count")
```


```{r, eval=FALSE}

# TODO - remove

agg_daily_trips_weather %>%
  ggplot(aes(x = temp_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")
```
