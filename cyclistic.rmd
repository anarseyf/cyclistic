---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

kable_custom <- function(data, ...) {
  knitr::kable(data,
    vline = "",
    format.args = list(big.mark = ","),
    ...
  ) %>%
    kable_styling(position = "left")
}


packages <- c("tidyr", "knitr", "ggplot2", "ggmap", "maps", "tibble", "ggnewscale", "kableExtra", "tinytex")
install.packages(setdiff(packages, rownames(installed.packages())), repos = "http://cran.us.r-project.org")

library(ggplot2)
library(ggmap)
library(maps)
library(dplyr)
library(tidyr)
library(knitr)
library(tibble)
library(ggnewscale)
library(kableExtra)

theme_set(theme_light())
```

```{r}
agg_daily_computed_weekdays <- read.csv("agg_daily_computed_weekdays.csv")
agg_daily <- read.csv("agg_daily_duration_count.csv")
agg_hourly <- read.csv("agg_hourly_status.csv")
agg_monthly <- read.csv("agg_monthly_status.csv")
agg_weekly_status <- read.csv("agg_weekly_status.csv")
agg_monthly_type_status <- read.csv("agg_monthly_type_status.csv")
stations_diff <- read.csv("stations_diff_8am_noon_4pm.csv")
stations_diff <- read.csv("stations_diff_8am_noon_4pm.csv")
weather_correlations <- read.csv("weather_correlations.csv")

agg_daily_trips_weather <- read.csv("agg_daily_trips_weather.csv")
agg_daily_trips_weather$day <- as.Date(agg_daily_trips_weather$day)

agg_weekly_weather <- read.csv("agg_weekly_weather.csv")
agg_weekly_weather$week_start <- as.Date(agg_weekly_weather$week_start)

weekday_names_full <- c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
weekday_names_short <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
```

# Cyclistic

- Anar Seyf (anar.seyf@gmail.com)
- October 2021
- Capstone project | Google Data Analytics course #8 | Coursera


## Data

Basic stats, etc.


## Analysis


### 1. Members ride more often, casual users ride for longer.

Overall stats TODO. Mini charts TODO. February outliers. Summer months #C > #M.

```{r}

wide <- agg_monthly %>%
  select(status, month_start, duration) %>%
  spread(month_start, duration)

month_starts <- colnames(wide)[2:13]
colnames(wide) <- c("Status", months(as.Date(month_starts), abbreviate = TRUE))

wide[, -1] <- round(wide[, -1])

wide %>%
  kable_custom(
    caption = "Average ride duration (minutes)"
  )
```

```{r}

wide <- agg_monthly %>%
  select(status, month_start, avg_count) %>%
  spread(month_start, avg_count)

month_starts <- colnames(wide)[2:13]
colnames(wide) <- c("Status", months(as.Date(month_starts), abbreviate = TRUE))

wide[, -1] <- round(wide[, -1])

wide %>%
  kable_custom(
    caption = "Average daily rides (count)"
  )
```


### 2. Members ride all week, casual riders prefer weekends.

Members' usage remains nearly flat, falling on Sunday. Casual users do most riding starting on Friday and through the weekend, peaking on Saturday.


### By weekday

```{r, fig.align='left'}
wide <- agg_weekly_status %>%
  select(-avg_count) %>%
  spread(dayofweek, avg_duration)

colnames(wide) <- c("Status", weekday_names_short)

wide %>% kable_custom(caption = "Average daily duration (minutes)")
```

```{r}

wide <- agg_weekly_status %>%
  select(-avg_duration) %>%
  spread(dayofweek, avg_count)

colnames(wide) <- c("Status", weekday_names_short)

wide %>%
  kable_custom(caption = "Average daily rides (count)")
```


#### Hourly

```{r, fig.width=4, fig.height=4, eval=FALSE}
agg_hourly %>%
  ggplot(aes(
    x = hour,
    y = factor(dayofweek, levels = unique(rev(dayofweek))),
    color = IS_MEMBER, size = COUNT
  )) +
  # scale_color_brewer(palette = "Pastel1") +
  geom_point(position = position_dodge(width = 0.5), alpha = 0.8) +
  theme(legend.position = "none")
```

```{r, fig.width=8, fig.height = 3}
agg_hourly %>%
  mutate(log_count = log(COUNT)) %>%
  ggplot(aes(
    x = dayofweek,
    y = factor(hour, levels = unique(rev(hour))),
    fill = log_count
  )) +
  geom_tile(color = "grey", position = position_dodge(width = 0.1)) +
  scale_fill_viridis_c(option = "plasma") +
  #  scale_fill_steps2(low = "white", mid = "yellow", high = "red", midpoint = 3) +
  facet_wrap(~IS_MEMBER)
```

### 3. Seasonal and Weather

**TODO** â€” eliminate 0 rain/snow circles.

```{r, fig.width=10, fig.height=3}
# head(agg_weekly_weather, n = 3)

# data_casual = agg_daily_trips_weather %>% filter(IS_MEMBER == "false")
# data_member = agg_daily_trips_weather %>% filter(IS_MEMBER == "true") %>%
#   mutate(COUNT = -1 * COUNT)

agg_weekly_weather %>%
  ggplot(aes(x = week_start)) +
  geom_bar(aes(y = Inf, fill = avg_temp), stat = "identity", alpha = 0.3, position = "dodge") +
  scale_fill_viridis_c() +
  new_scale_fill() +
  # geom_bar(aes(y = avg_count, fill = is_member), stat = "identity") +
  geom_step(aes(y = avg_count, group = is_member, color = is_member, size = 0.5), stat = "identity") +
  geom_point(aes(y = 0, size = total_snow / 10), color = "#e30f84", alpha = 0.7) +
  geom_point(aes(y = 0, size = total_rain), color = "#2192d3", alpha = 0.7)
# facet_wrap(~is_member, ncol = 1)
```

```{r}
weather_correlations %>% kable_custom(caption = "Correlation: weather and ride count")
```

```{r}
# d <- agg_weekly_weather %>%
#   filter(is_member == "true") %>%
#   filter(weekly_rain_total > 0) %>%
#   select(-is_member)

# p <- ggplot(data = d, aes(x = year_week, y = weekly_temp_avg, group = 1))

# p +
#   geom_ribbon(aes(
#     ymin = weekly_temp_min, ymax = weekly_temp_max,
#     alpha = 0.8
#   )) +
#   geom_line() +
#   geom_point(aes(y = 0, size = weekly_rain_total, color = weekly_rain_total, alpha = 0.8))
```

### ---------------------------------------

#### Monthly by weekday

```{r, eval=FALSE}
plot <- agg_daily_computed_weekdays %>%
  group_by(year_month, dayofweek, IS_MEMBER) %>%
  summarize(AVG_COUNT = mean(COUNT), AVG_DURATION = mean(AVG_DURATION))

plot %>%
  ggplot(aes(x = dayofweek, y = AVG_COUNT, color = IS_MEMBER, size = AVG_DURATION)) +
  geom_point(alpha = 0.8) +
  facet_wrap(~year_month, ncol = 3)
```


#### Weekly Counts and Average Duration

Full year, weekly.
```{r, eval=FALSE, echo=FALSE, fig.width=8, fig.height=2}
agg_daily_computed_weekdays %>%
  ggplot(aes(
    x = factor(weeknum, levels = unique(weeknum)),
    y = COUNT,
    fill = IS_MEMBER
  )) +
  geom_bar(stat = "identity", alpha = 0.8) +
  theme(legend.position = "none")
```

```{r, eval=FALSE, fig.width=8, fig.height=2}
# y = factor(weeknum, levels = unique(rev(weeknum)))
agg_daily_computed_weekdays %>%
  # select(-STDDEV_DURATION, -MIN_DURATION, -MAX_DURATION) %>%
  group_by(weeknum, IS_MEMBER) %>%
  summarize(WEEKLY_AVG_DURATION = mean(AVG_DURATION)) %>%
  ggplot(aes(
    x = factor(weeknum, levels = unique(weeknum)),
    y = WEEKLY_AVG_DURATION,
    fill = IS_MEMBER
  )) +
  geom_bar(stat = "identity", alpha = 0.8) +
  theme(legend.position = "none")
```

Note: **not weighted average** for the graph above.

#### Monthly by bike type

```{r, eval=FALSE}

agg_monthly_type_status %>%
  ggplot(aes(x = is_member, y = total_count, fill = type)) +
  geom_col() +
  facet_wrap(~year_month, ncol = 3)
```

## The Weather


#### Temperature

In degrees C.

```{r, eval=FALSE, out.width='45%', out.aspect=0.3}

ggplot(data = agg_daily_trips_weather, aes(x = temp_avg, y = COUNT, color = IS_MEMBER, size = AVG_DURATION)) +
  geom_point(alpha = 0.8)
```
```{r, eval=FALSE, out.width='45%', out.aspect=0.3}
ggplot(data = agg_daily_trips_weather, aes(x = temp_avg, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_histogram(binwidth = 1, alpha = 0.8)
```

```{r, eval=FALSE, out.width='45%'}
agg_daily_trips_weather %>%
  ggplot(aes(x = temp_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")
```


#### Rain

Rain (mm) vs ride count

```{r, eval=FALSE, out.width='45%', out.aspect=0.3}
agg_daily_trips_weather %>%
  filter(rain <= 20) %>%
  ggplot(aes(x = rain, fill = IS_MEMBER, size = AVG_DURATION)) +
  # scale_fill_brewer(palette = "Pastel1") +
  geom_histogram(binwidth = 1, alpha = 0.8)
```
```{r, eval=FALSE, out.width='45%', out.aspect=0.3}
agg_daily_trips_weather %>%
  filter(rain <= 20) %>%
  ggplot(aes(x = rain, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  scale_y_continuous(labels = scales::percent) +
  # scale_fill_brewer(palette = "Pastel1") +
  theme(legend.position = "none")
```


#### Wind

Wind (m/s) vs ride count.

Second graph is scaled to 100% to show member vs casual share.

```{r, eval=FALSE, out.width='30%'}
agg_daily_trips_weather %>%
  filter(wind_avg <= 10) %>%
  ggplot(aes(x = wind_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(alpha = 0.8) +
  # scale_fill_brewer(palette = "Pastel1") +
  scale_x_binned()
```
```{r, eval=FALSE, out.width='30%'}
agg_daily_trips_weather %>%
  filter(wind_avg <= 10) %>%
  ggplot(aes(x = wind_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  # scale_fill_brewer(palette = "Pastel1") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")
```

## The Geography

#### Stations

**1288** stations. Following: **casual vs members**, **8am vs 4pm**, **Monday-Friday**.

Each dot is a bike docking station. Stations highlighed **yellow-red** have more arrivals than departures for the given hour, suggesting an influx of bike traffic at that location.

```{r, eval=FALSE}
stations_diff <- stations_diff %>% arrange(diff)

index <- stations_diff$diff > 0
stations_diff$log_diff[index] <- log10(stations_diff$diff[index])
stations_diff$log_diff[stations_diff$diff <= 0] <- NA

color_scale <- scale_color_steps(low = "#ffff17", high = "#e90505", na.value = "#072d66")

# map11 <- get_map(location = "Chicago", zoom = 11, maptype = "toner")
map12 <- get_map(location = "Chicago", zoom = 12, maptype = "toner")

alpha <- 0.6
darken <- 0.4
```

#### Friday, 4pm, casual vs members

```{r, eval=FALSE, fig.width = 8, fig.height = 4}
heatmap_large <- stations_diff %>%
  filter(dayofweek == 5) %>%
  filter(hour == 16)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_large, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_wrap(~is_member)
```

#### 8am, Monday-Sunday, casual vs members
```{r, eval=FALSE, fig.width=10, fig.height=4}
heatmap_member <- stations_diff %>%
  filter(hour == 8)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_member, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_grid(is_member ~ dayofweek)
```

#### 4pm, Monday-Sunday, casual vs members
```{r, eval=FALSE, fig.width=10, fig.height=4}
heatmap_casual <- stations_diff %>%
  filter(hour == 16)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_casual, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_grid(is_member ~ dayofweek)
```

