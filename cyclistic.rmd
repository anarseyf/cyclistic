```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
packages <- c("tidyr", "ggplot2", "ggmap", "maps")
install.packages(setdiff(packages, rownames(installed.packages())), repos = "http://cran.us.r-project.org")
library(ggplot2)
library(ggmap)
library(maps)
library(tidyr)
theme_set(theme_light())
```

# Cyclistic

- Anar Seyf (anar.seyf@gmail.com)
- October 2021
- Capstone project | Google Data Analytics course #8 | Coursera

```{r}
agg_daily_computed_weekdays <- read.csv("agg_daily_computed_weekdays.csv")
agg_daily <- read.csv("agg_daily_duration_count.csv")
agg_hourly <- read.csv("agg_hourly_status.csv")
```

## The Graphs

#### Aggregate by day of week

```{r}
agg_summarized <- agg_daily %>%
  group_by(YEAR_MONTH, DAYOFWEEK, IS_MEMBER) %>%
  summarize(MEAN_DURATION = mean(AVG_DURATION), MEAN_COUNT = mean(COUNT))
```

#### Monthly by weekday

```{r}
plot <- agg_daily_computed_weekdays %>%
  group_by(year_month, dayofweek, IS_MEMBER) %>%
  summarize(AVG_COUNT = mean(COUNT), AVG_DURATION = mean(AVG_DURATION))

plot %>%
  ggplot(aes(x = dayofweek, y = AVG_COUNT, color = IS_MEMBER, size = AVG_DURATION)) +
  geom_point(alpha = 0.8) +
  facet_wrap(~year_month, ncol = 3)
```

#### Overall by weekday

```{r, fig.width=4, fig.height=2}
plot <- agg_daily_computed_weekdays %>%
  group_by(dayofweek, IS_MEMBER) %>%
  summarize(AVG_COUNT = mean(COUNT), AVG_DURATION = mean(AVG_DURATION))

head(plot, n = 2)

plot %>%
  ggplot(aes(x = dayofweek, y = AVG_COUNT, color = IS_MEMBER, size = AVG_DURATION)) +
  geom_point(alpha = 0.8)
# theme(legend.position = "none")
```

#### Hourly

```{r, fig.width=8, fig.height=4}
agg_hourly %>%
  ggplot(aes(
    x = hour,
    y = factor(dayofweek, levels = unique(rev(dayofweek))),
    color = IS_MEMBER, size = COUNT
  )) +
  # scale_color_brewer(palette = "Pastel1") +
  geom_point(position = position_dodge(width = 0.5), alpha = 0.8)
```

#### Weekly Counts and Average Duration

Full year, weekly.
```{r, echo=FALSE, fig.width=8, fig.height=2}
head(agg_daily_computed_weekdays, n = 2)

agg_daily_computed_weekdays %>%
  ggplot(aes(
    x = factor(weeknum, levels = unique(weeknum)),
    y = COUNT,
    fill = IS_MEMBER
  )) +
  geom_bar(stat = "identity", alpha = 0.8) +
  theme(legend.position = "none")
```

```{r, fig.width=8, fig.height=2}
# y = factor(weeknum, levels = unique(rev(weeknum)))
agg_daily_computed_weekdays %>%
  # select(-STDDEV_DURATION, -MIN_DURATION, -MAX_DURATION) %>%
  group_by(weeknum, IS_MEMBER) %>%
  summarize(WEEKLY_AVG_DURATION = mean(AVG_DURATION)) %>%
  ggplot(aes(
    x = factor(weeknum, levels = unique(weeknum)),
    y = WEEKLY_AVG_DURATION,
    fill = IS_MEMBER
  )) +
  geom_bar(stat = "identity", alpha = 0.8) +
  theme(legend.position = "none")
```

Note: **not weighted average** for the graph above.

#### Monthly by bike type

```{r}
agg_monthly_type_status <- read.csv("agg_monthly_type_status.csv")
head(agg_monthly_type_status, n = 2)

agg_monthly_type_status %>%
  ggplot(aes(x = is_member, y = total_count, fill = type)) +
  geom_col() +
  facet_wrap(~year_month, ncol = 3)
```

## The Weather

#### Weekly

**TODO** â€” either use a weather-only dataset or show trips alongside weather.

```{r, fig.width=8, fig.height=2}
agg_weekly_weather <- read.csv("agg_weekly_weather.csv")
head(agg_weekly_weather, n = 3)

d <- agg_weekly_weather %>%
  filter(is_member == "true") %>%
  select(-is_member)

p <- ggplot(data = d, aes(x = year_week, y = weekly_temp_avg, group = 1))

p +
  geom_ribbon(aes(
    ymin = weekly_temp_min, ymax = weekly_temp_max,
    alpha = 0.8
  )) +
  geom_line() +
  geom_point(aes(y = 0, size = weekly_rain_total, color = weekly_rain_total, alpha = 0.8))
```

**TODO: Recompute** on new daily aggregates.

```{r}
weather <- read.csv("agg-daily-trips-weather.csv")
weather %>%
  select(-wind_2min_peak, -temp_min, -temp_max) %>%
  head(n = 2)
```


#### Temperature

In degrees C.

```{r, out.width='45%', out.aspect=0.3}

ggplot(data = weather, aes(x = temp_avg, y = COUNT, color = IS_MEMBER, size = AVG_DURATION)) +
  geom_point(alpha = 0.8)
```
```{r, out.width='45%', out.aspect=0.3}
ggplot(data = weather, aes(x = temp_avg, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_histogram(binwidth = 1, alpha = 0.8)
```

```{r, out.width='45%'}
weather %>%
  ggplot(aes(x = temp_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")
```


#### Rain

Rain (mm) vs ride count

```{r, out.width='45%', out.aspect=0.3}
weather %>%
  filter(rain <= 20) %>%
  ggplot(aes(x = rain, fill = IS_MEMBER, size = AVG_DURATION)) +
  # scale_fill_brewer(palette = "Pastel1") +
  geom_histogram(binwidth = 1, alpha = 0.8)
```
```{r, out.width='45%', out.aspect=0.3}
weather %>%
  filter(rain <= 20) %>%
  ggplot(aes(x = rain, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  scale_y_continuous(labels = scales::percent) +
  # scale_fill_brewer(palette = "Pastel1") +
  theme(legend.position = "none")
```


#### Wind

Wind (m/s) vs ride count.

Second graph is scaled to 100% to show member vs casual share.

```{r, out.width='30%'}
weather %>%
  filter(wind_avg <= 10) %>%
  ggplot(aes(x = wind_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(alpha = 0.8) +
  # scale_fill_brewer(palette = "Pastel1") +
  scale_x_binned()
```
```{r, out.width='30%'}
weather %>%
  filter(wind_avg <= 10) %>%
  ggplot(aes(x = wind_avg, y = COUNT, fill = IS_MEMBER, size = AVG_DURATION)) +
  geom_col(position = "fill", alpha = 0.8) +
  scale_x_binned() +
  # scale_fill_brewer(palette = "Pastel1") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")
```

## The Geography

#### Stations

**1288** stations. Following: **non-members vs members**, **8am vs 4pm**, **Monday-Friday**.

Each dot is a bike docking station. Stations highlighed **yellow-red** have more arrivals than departures for the given hour, suggesting an influx of bike traffic at that location.

```{r}
stations_diff <- read.csv("stations_diff_8am_noon_4pm.csv")

stations_diff <- stations_diff %>% arrange(diff)

index <- stations_diff$diff > 0
stations_diff$log_diff[index] <- log10(stations_diff$diff[index])
stations_diff$log_diff[stations_diff$diff <= 0] <- NA

color_scale <- scale_color_steps(low = "#ffff17", high = "#e90505", na.value = "#072d66")

# map11 <- get_map(location = "Chicago", zoom = 11, maptype = "toner")
map12 <- get_map(location = "Chicago", zoom = 12, maptype = "toner")

alpha <- 0.8
darken <- 0.4
```

#### Friday, 4pm, non-members vs members

```{r, fig.width = 8, fig.height = 4}
heatmap_large <- stations_diff %>%
  filter(dayofweek == 5) %>%
  filter(hour == 16)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_large, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_wrap(~is_member)
```

#### 8am, Monday-Sunday, casual vs members
```{r, fig.width=10, fig.height=4}
heatmap_member <- stations_diff %>%
  filter(hour == 8)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_member, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_grid(is_member ~ dayofweek)
```

#### 4pm, Monday-Sunday, casual vs members
```{r, fig.width=10, fig.height=4}
heatmap_casual <- stations_diff %>%
  filter(hour == 16)

ggmap(map12, darken = darken) +
  # ggplot() +
  geom_point(data = heatmap_casual, aes(x = lng, y = lat, color = log_diff), alpha = alpha) + color_scale +
  facet_grid(is_member ~ dayofweek)
```

