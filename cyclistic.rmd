---
output: pdf_document
---

```{r packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

packages <- c(
  "tidyr", "knitr", "ggplot2", "ggmap", "gridExtra", "ggthemes",
  "maps", "tibble", "ggnewscale", "kableExtra", "tinytex", "extrafont", "fontcm"
)
install.packages(setdiff(packages, rownames(installed.packages())),
  repos = "http://cran.us.r-project.org"
)

library(ggplot2)
library(ggmap)
library(maps)
library(dplyr)
library(tidyr)
library(knitr)
library(tibble)
library(ggnewscale)
library(kableExtra)
library(gridExtra)
library(grid)
library(scales)
library(extrafont)
library(fontcm)
library(ggthemes)

font_install("fontcm")
loadfonts()
```

```{r theme}

# TODO — theme_tufte? lol

theme_set(theme_minimal(
  base_family = "Times",
))
theme_update(
  axis.title = element_blank(),
  legend.position = "none",
  strip.background = element_rect(fill = "white", color = NA),
  strip.text = element_text(size = 11),
  axis.text = element_text(size = 9),
  axis.line = element_line(size = 0.25)
)

colors_IS_MEMBER <- scale_color_manual(values = c("darkred", "darkgreen"))

map_color_scale <- scale_color_steps(
  low = "#ffff17", high = "#e90505", na.value = "#072d66"
)

theme_no_axis_labels <- theme(axis.text = element_blank())
```

```{r functions, echo=FALSE}

kable_custom <- function(data, full_width = FALSE, ...) {
  kbl(
    data,
    booktabs = TRUE,
    format.args = list(big.mark = ","),
    align = c("l", rep("r", ncol(data) - 1)),
    ...
  ) %>%
    kable_styling(
      # position = "left",
      latex_options = c("HOLD_position"),
      full_width = full_width
    )
}

bold_larger_fn <- function(x) {
  cell_spec(x, italic = ifelse(x == max(x), TRUE, FALSE))
}

weekday_ticks <- function() {
  function(x) {
    weekday_names_short
  }
}

hour_ticks <- function() {
  function(x) {
    lapply(x, to_readable_hour)
  }
}

to_readable_hour <- function(h) {
  n <- as.numeric(h)
  if (n == 0) {
    return("midnight")
  }
  if (n == 12) {
    return("noon")
  }

  am_pm <- ifelse(n < 12, "am", "pm")
  if (n > 12) {
    n <- n - 12
  }
  return(paste(c(n, am_pm), collapse = ""))
}

member_labeller <- function(v) {
  ifelse(v == "true", "Member", "Casual")
}

weekday_labeller <- function(v) {
  weekday_names_short[as.numeric(v)]
}
```

```{r data imports}
agg_daily_computed_weekdays <- read.csv("agg_daily_computed_weekdays.csv")
agg_daily <- read.csv("agg_daily_duration_count.csv")
agg_hourly <- read.csv("agg_hourly_status.csv")
agg_monthly <- read.csv("agg_monthly_status.csv")
agg_weekly_status <- read.csv("agg_weekly_status.csv")
agg_monthly_type_status <- read.csv("agg_monthly_type_status.csv")
weather_correlations <- read.csv("weather_correlations.csv")
wx_correlations <- read.csv("wx_correlations.csv")

agg_daily_trips_weather <- read.csv("agg_daily_trips_weather.csv")
agg_daily_trips_weather$day <- as.Date(agg_daily_trips_weather$day)

agg_weekly_weather <- read.csv("agg_weekly_weather.csv")
agg_weekly_weather$week_start <- as.Date(agg_weekly_weather$week_start)

stations_diff <- read.csv("stations_diff_june.csv") %>% arrange(diff)

weekday_names_full <- c(
  "Monday", "Tuesday",
  "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"
)
weekday_names_short <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
```

# Cyclistic

- Anar Seyf | anar.seyf@gmail.com
- Capstone project | Google Data Analytics course #8 | Coursera
- October 2021
- Source code: [github.com/anarseyf/cyclistic](github.com/anarseyf/cyclistic)

---

## Introduction

This report is the capstone project for the Google Data Analytics professional certificate on Coursera [**[1]**](#links). The starting point is data from Cyclistic, a bike-sharing company which operates a network of classic and electric bicycles and docking stations in Chicago. The goal is to understand usage patterns between **Casual** riders (those who pay for single rides or day passes) and **Members** (those who purchased an annual membership), and to provide recommendations to the Cyclistic marketing team on how to convert casual riders into members.

---

## Data

Our main dataset contains individual ride records over a twelve-month period—October 2020 to September 2021, inclusive—provided in monthly .csv files [**[1]**](#links). This amounts to over 5 million rows with these columns:

* unique ride ID;
* status (member or casual)
* start and end time;
* start and end docking station (ID and name);
* start and end latitude/longitude;
* bicycle type (classic, docked, electric);

The individual records are aggregated into hourly, daily, and weekly tables, and grouped by status (member vs casual). For example, the daily aggregates table consists of 730 entries (365 for Members and Casual riders each) with columns for average daily ride count and average duration. (See appendix on [**[tools used]**](#tools) and [**[data cleanup steps]**](#cleanup).)

## Analysis

### 1. Members ride more often, casual users ride for longer.

An average ride is about **14 minutes** long for Members and **28 minutes** long for Casual riders. Members make an average of **7,479** rides per day, compared to **6,362** for Casual riders. (The number of distinct riders is unavailable in the data, so we can only refer to the overall groups. Daily totals can provide a rough approximation, but only within the order of magnitude.) 

Ride volume is lowest in February and highest in July-August. Casual ride volume exceeds that of Members in the summer months only.

```{r, eval=TRUE}

wide <- agg_monthly %>%
  select(status, month_start, avg_count) %>%
  spread(month_start, avg_count)

month_starts <- colnames(wide)[2:13]
colnames(wide) <- c(" ", months(as.Date(month_starts), abbreviate = TRUE))

wide[, -1] <- round(wide[, -1])

wide %>%
  format(big.mark = ",") %>%
  mutate(across(Oct:Sep, bold_larger_fn)) %>%
  kable_custom(
    full_width = TRUE,
    escape = FALSE,
    caption = "Average daily number of rides"
  ) %>%
  footnote(
    # general_title = "Note: ",
    general = "In this table and Table 3, the larger of the two numbers for each month is in italics."
  )
```

Ride duration is nearly flat for Members throughout the year; for Casual riders it increases by a few minutes in the summer months.

```{r, eval=TRUE}

wide <- agg_monthly %>%
  select(status, month_start, duration) %>%
  spread(month_start, duration)

month_starts <- colnames(wide)[2:13]
colnames(wide) <- c(" ", months(as.Date(month_starts), abbreviate = TRUE))

wide[, -1] <- round(wide[, -1])

wide %>%
  kable_custom(caption = "Average ride duration (minutes)")
```

(February has an abnormal spike in ride duration. It may be partly attributable to low ride volume and thus higher variance in the data, but is otherwise not readily explainable here. It is likely to be weather-related—perhaps due to difficulties of reaching a docking station; see section 3 for more details.)

### 2. Members ride all week, casual riders prefer weekends.

Ride volume remains nearly flat for Members through the week, reducing only on Sundays. Casual users do the most riding over the weekend, peaking on Saturdays.

```{r, eval=TRUE}

wide <- agg_weekly_status %>%
  select(-avg_duration) %>%
  spread(dayofweek, avg_count)

colnames(wide) <- c(" ", weekday_names_short)

wide %>%
  format(big.mark = ",") %>%
  mutate(across(Mon:Sun, bold_larger_fn)) %>%
  kable_custom(
    escape = FALSE,
    caption = "Average daily number of rides"
  )
```

```{r, eval=TRUE}

wide <- agg_weekly_status %>%
  select(-avg_count) %>%
  spread(dayofweek, avg_duration)

colnames(wide) <- c(" ", weekday_names_short)

wide %>% kable_custom(caption = "Average ride duration (minutes)")
```

#### Hourly heatmap

This heatmap is a more detailed view of the data from _Table 3_. The Monday–Friday pattern for Members closely matches standard working hours; note especially the peak around 4–5pm. Weekend patterns are much closer between the two groups, apart from volume; note, for example, Saturday evening activity spilling over into early morning on Sunday.

```{r, fig.width=8, fig.height=3, eval=FALSE}

agg_hourly %>%
  ggplot(aes(
    x = dayofweek,
    y = factor(hour, levels = unique(rev(hour))),
    fill = COUNT
  )) +
  geom_tile(color = "grey", position = position_dodge(width = 0.1)) +
  scale_fill_viridis_c(option = "viridis", trans = pseudo_log_trans()) +
  # scale_fill_gradientn(colors = heat.colors(20), trans = pseudo_log_trans()) +
  # scale_fill_gradient(
  #   low = "black", high = "yellow",
  #   trans = pseudo_log_trans()
  # ) +
  scale_x_continuous(labels = weekday_ticks(), breaks = 1:7, expand = c(0, 0)) +
  scale_y_discrete(labels = hour_ticks(), breaks = seq(0, 23, 4)) +
  facet_wrap(~IS_MEMBER, labeller = labeller(IS_MEMBER = member_labeller)) +
  labs(caption = "Ride count heatmap (time of day on vertical axis)")
```

### 3. Seasons affect ride volume, but average duration remains stable

This section uses the Chicago daily weather dataset from NOAA; see [**[Links]**](#links) for data source.

The following chart plots one year of ride data, aggregated by week, against weather for that week: average daily air temperature, cumulative rain, and cumulative snow.

```{r, fig.width=10, fig.height=3, eval=TRUE}

month_labels <- function(x) {
  months(x, abbreviate = TRUE)
}

df <- agg_weekly_weather

df %>%
  ggplot(aes(x = week_start)) +
  geom_bar(aes(y = Inf, fill = avg_temp),
    stat = "identity", alpha = 0.3, position = "dodge"
  ) +
  scale_fill_viridis_c(option = "magma") +
  new_scale_fill() +
  # new_scale_color() +

  geom_step(aes(
    y = avg_count,
    group = is_member,
    color = is_member,
  ),
  size = 1.25,
  stat = "identity"
  ) +
  geom_point(aes(
    y = avg_count,
    group = is_member,
    color = is_member,
    fill = is_member
  ),
  shape = 22, # https://r-graphics.org/recipe-scatter-shapes#discussion-28
  # fill = "white",
  size = 2,
  stroke = 2
  ) +
  colors_IS_MEMBER +
  scale_fill_manual(values = c("white", "darkgreen")) +

  # new_scale_fill() +
  # new_scale_color() +

  geom_point(
    data = subset(df, total_snow > 0),
    aes(y = -2000, size = total_snow / 10), shape = 23, fill = "#9b037a", alpha = 0.7
  ) +
  guides(size = guide_legend(title = "Snow (mm)")) +
  geom_point(
    data = subset(df, total_rain > 0),
    aes(y = -1000, size = total_rain), color = "#2192d3", alpha = 0.7
  ) +
  scale_x_date(expand = c(0, 0), labels = month_labels, date_breaks = "months") +
  scale_y_continuous(expand = c(0, 1000)) +
  geom_vline(xintercept = as.Date("2021-01-01"), size = 0.5) +
  theme(legend.position = "right") +
  labs(caption = "Weather Oct 2020-Sep 2021. Background = avg temp, etc.")
```

```{r, eval=TRUE}
text <- "The Pearson correlation coefficient (r) measures how strongly two sets of data are linearly correlated, from -1 (perfect negative) to 1 (perfect positive), with 0 indicating no correlation. Here, for example, ride count is negatively correlated with snow: the more snow, the fewer rides."

colnames <- c(" ", "Temperature", "Rain", "Snow", "Wind", "Temperature", "Rain", "Snow", "Wind")

wx_correlations %>%
  kable_custom(
    col.names = colnames,
    caption = "Correlation (r): ride volume vs. weather factors"
  ) %>%
  add_header_above(c(" " = 1, "Count" = 4, "Duration" = 4)) %>%
  column_spec(c(2, 6), bold = TRUE) %>%
  footnote(general = text, threeparttable = TRUE, general_title = " ")
```

Table 5 shows that the number of rides on a given day is strongly—almost perfectly—correlated with **air temperature** for both groups; duration, on the other hand, shows almost no correlation. The following plots help illustrate this relationship. Each circle represents one day; 365 circles for each plot; the diagonal lines represent best linear fit and confidence intervals.

```{r, fig.height=2, eval=TRUE}

alpha <- 0.3

temp_breaks <-
  scale_x_continuous(breaks = c(-10, 0, 10, 20))

duration_breaks <- scale_y_continuous(breaks = c(20, 30, 40))

scatterplot <- agg_daily_trips_weather %>%
  filter(AVG_DURATION < 100)

p1 <- scatterplot %>%
  ggplot(
    aes(x = temp_avg, y = COUNT, color = IS_MEMBER)
  ) +
  colors_IS_MEMBER +
  geom_point(alpha = alpha) +
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 0, linetype = "dotted", size = 0.5) +
  temp_breaks +
  facet_wrap(~IS_MEMBER, labeller = labeller(IS_MEMBER = member_labeller)) +
  labs(caption = "Air temperature (\u00B0C) vs. number of rides") +
  guides(color = "none")

p2 <- scatterplot %>%
  ggplot(aes(x = temp_avg, y = AVG_DURATION, color = IS_MEMBER)) +
  colors_IS_MEMBER +
  geom_point(alpha = alpha) +
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 0, linetype = "dotted", size = 0.5) +
  temp_breaks +
  duration_breaks +
  facet_wrap(~IS_MEMBER, labeller = labeller(IS_MEMBER = member_labeller)) +
  labs(
    caption = "Air temperature (\u00B0C) vs. ride duration (minutes)",
  ) +
  guides(color = "none")

grid.arrange(p1, p2, nrow = 1)
```

**Rain** is more ambiguous: correlation is close to 0. Does this mean bike-share users in Chicago are not influenced by rain at all? The more plausible explanation is that we are at the limits of this dataset. In the 12-month period, 256 days had no recorded rain, and only 16 days had half an inch or more; on those days, Members rode for 4% less total time, and Casual riders 6% more, than on days with less rain. In other words, it did not rain enough to make the relationship clear.

These distributions confirm an observation from section 1: average ride duration remains nearly flat (more so for Members), but ride volume can vary significantly.

### 4. Geographical

(TODO)

Stations: 1288 distinct stations (saved in table). 85% of trips (4293771 out of 5051830) have both start and end station ID — we focus on those when mapping. These are split almost evenly between M (54.7%) and C.

Stations: 4007812 trips end at a different station from start; 285959 trips start and end at the same station.

### Stations

**TODO** — # of rides with start & end station (85%).
**1288** stations. Following: **casual vs members**, **8am vs 4pm**, **Monday-Friday**.

Each dot is a bike docking station. Stations highlighed **yellow-red** have more arrivals than departures for the given hour, suggesting an influx of bike traffic at that location.

TODO: Heatmap: instead of each weekday, take a month out of each quarter?

```{r, eval=FALSE}

index <- stations_diff$diff > 0

# TODO — try log_trans scale instead?

stations_diff$log_diff[index] <- log10(stations_diff$diff[index])
stations_diff$log_diff[stations_diff$diff <= 0] <- NA

# map12 <- get_map(location = "Chicago", zoom = 12, maptype = "toner")
# map13 <- get_map(location = "Chicago", zoom = 13, maptype = "toner")

alpha <- 0.6
darken <- 0.4
```

### Friday morning (8-10am)

```{r, fig.width=6, fig.height=3, eval=FALSE}

heatmap_large <- stations_diff %>%
  filter(dayofweek == 5) %>%
  filter(hour == 8 | hour == 9)

# ggmap(map12, darken = darken) +
ggplot() +
  geom_point(
    data = heatmap_large,
    aes(x = lng, y = lat, color = log_diff), alpha = alpha
  ) +
  map_color_scale +
  theme_no_axis_labels
# facet_wrap(~is_member, labeller = labeller(is_member = member_labeller))
```

Let's look at the same pattern across the entire week.

### Morning (8-9am)

```{r, fig.height=3, eval=FALSE}
heatmap1 <- stations_diff %>%
  filter(hour == 8)

# ggmap(map13, darken = darken) +
ggplot() +
  geom_point(
    data = heatmap1,
    aes(x = lng, y = lat, color = log_diff), alpha = alpha
  ) +
  map_color_scale +
  theme_no_axis_labels +
  facet_grid(is_member ~ dayofweek, labeller = labeller(dayofweek = weekday_labeller, is_member = member_labeller))
```

A distinct weekday pattern. Apart from volume, the "fingerprints" look similar for the two groups. On weekends it looks different: there isn't a lot of casual riding into this area in the morning.


### Afternoon (4-5pm)

```{r, fig.height=3, eval=FALSE}
heatmap2 <- stations_diff %>%
  filter(hour == 16)

# ggmap(map13, darken = darken) +
ggplot() +
  geom_point(
    data = heatmap2,
    aes(x = lng, y = lat, color = log_diff), alpha = alpha
  ) +
  map_color_scale +
  theme_no_axis_labels +
  facet_grid(is_member ~ dayofweek, labeller = labeller(dayofweek = weekday_labeller, is_member = member_labeller))
```

More dispersion away from center (TODO).
Key takeaway: patterns are distinct by time of day and weekday vs weekend, but less so between C and M.

---

## Conclusions

### 1. Casual riders use the service as more of a luxury, and members as a utility.

- Weekend spike
- Ride duration: starting a ride is a bigger commitment for a casual user. A 15-minute ride is a non-issue for a member, but not if you are paying for a single pass.
- The distinctions are not due to any inherent difference between rider types, but due to the convenience factor. (Running errands, commuting.) Barrier to entry is higher for C than M.

### 2. The two groups' usage patterns overlap.

The groups are not inherently distinct in their goals. The patterns likely differ as a result of ...

- Similar geographic patterns, hourly patterns, weekday vs weekend
- Commuting, daily tasks?
* Similarities M vs C? Modes (work hours vs weekend)
* Lower variance for M than C. More consistent patterns.

---

## Recommendations

How to convert casual riders into members?

### 1. Nudge casual riders toward memberships with free trials

- Turn a single pass into a free weekly or monthly trial.
- Have they had a chance or reason to consider Cyclistic as a realistic, always-available mode of transport?
- The pool of casual riders is the first potential market for memberships.
- This pool, however, is potentially smaller than the existing Membership base.

### 2. Address specific modes of riding

- Suggest bikes as a mode of work commute
- Run promotions on weekends with major sporting events where cycling would help avoid traffic and parking problems

### 3. ~~People outside the system. Never tried the service (or cycling regularly).~~

- Why? Does their neighborhood lack docking stations? Underserved areas? Too far to work?
- Do they need help with route planning?
- Work with the city on expanding cycling routes and making cycling safer.
- Weather? Seasons?

---

## Appendix

### Limitations

The available dataset is limited. It does not, for example, contain any membership data, so seasonal trends could be partly attributable to membership growth, etc.

### Out of scope

Out of scope: 

* bike types; 
* other factors (natural disasters, sporting events, etc.); 
* pricing; 
* individual user profiles
* trends (year-over-year, electric, geography, etc.)
* other modes of transport
* region specifics

### Data cleanup {#cleaning}

February: 16-Feb-2021 had a few rides of close to 24 hours. 
Overall, most long rides (12+ hours) are attributed to Casual riders, which likely corresponds to 24-hour rentals. Not enough info to interpret this further.
Test data; NOTES FROM GOOGLE DOC

Presentation: log scale.


### Links {#links}

Data sources (incl. Google Maps, Stamen).

1. Coursera — Google Data Analytics
   - https://www.coursera.org/professional-certificates/google-data-analytics
1. BigQuery
   - https://cloud.google.com/bigquery
1. Dataset
   - https://divvy-tripdata.s3.amazonaws.com/index.html
1. NOAA Chicago daily weather. Collected at O'Hare Airport.
   - https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USW00094846/detail
1. Pearson correlation coefficient
   - https://en.wikipedia.org/wiki/Pearson_correlation_coefficient

### Tools {#tools}

* Google Sheets
* BigQuery
* R (in VSCode)
* knitr (PDF)
(links TODO)






